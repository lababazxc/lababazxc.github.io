---
title: 全链路压测的一点认知
date: 2021-11-01 20:06:43
tags:
---
#### 前言

上周周末参加了两场测试沙龙，收获良多。就其中大家目前关注度比较多的话题进行一个总结和学习。其中一个是全链路压测，另一个是流量回放。这里主要总结全链路压测的内容。本文总体为概述型，若有实际操作的需求，可以参考文末链接。

---

#### 什么是全链路压测

一般性能测试针对于单个系统/服务/组件/接口，它们都有一些共通的特点：用户热点业务场景，或者关键的业务场景。例如淘宝首页、下订单。那么我们通常对这些关键场景进行设计，只要能够通过压力测试，那就认为整个系统能够支撑业务的需要。

全链路压测的出现打破了这个思维。全链路压测，顾名思义，即对整个业务链路进行压测。相较于传统性能测试，全链路压测关注度更广，着眼于整个业务域，而非仅仅某一个场景。

那么为什么单系统压测的结果不准确呢？在活动开始的那一刻，流量就会瞬间达到峰值，各个服务都会面临巨大的压力。此时若链路中的某一个环节出现了故障，由于系统之间的依赖关系，故障可能沿着业务链路传递下去，使造成的影响无法评估。而单机压测则未考虑到此种情况。且全链路压测出来的情况更贴近真实生产情况，提前暴露生产风险。

是一个针对业务张静越发复杂化，海量数据冲击，发现并解决整个业务系统的可用性、扩展性以及容错性的过程。



---

#### 传统压测vs全链路压测

| 压测类型 |            传统压测            |        全链路压测         |
| :------: | :----------------------------: | :-----------------------: |
| 压测方式 |   Jmeter、Locust、Loadrunner   |    流量回放、压测集群     |
| 压测环境 |       测试环境、性能环境       |         生产环境          |
| 环境特点 |         配置低/不稳定          |     环境稳定/真实线上     |
| 压测场景 |          单机/单链路           |     核心链路及其场景      |
|   成本   | 需要投入人力新建、维护压测环境 | 线上生产环境，成本接近于0 |

一般的压测流程为：压测需求的提出 --> 评估技术方案 --> 搭建压测环境/压测数据准备 --> 执行测试 --> 生成报告。

压测的需求可以来源于：

- 新功能的交付。此时对功能的上限无明确的认知，需要压测提供标准；
- 测试已有功能是否达标。
- 日常性压测，为将来的工作提供参考依据。

技术方案中需要根据压测的目标，给出机器数量、部署架构、执行流程、考核指标。

评估过后根据技术方案搭建环境、准备数据。传统的数据构造，一般由测试人员自己维护一批压测数据。但这种方式存在很大的弊端，一方面维护成本相对较高，另一方面，其构造出的数据多样性也不足够。或通过数据工厂来构造千万、亿级数据。而全链路压测通常会dump线上数据作为压测流量，同时针对整个压测范围，依赖接口可以做人工标注。哪些需要Mock，哪些不需要Mock，如此压测特有的链路信息能够得到持续的维护。

----

#### 全链路压测需要注意的点

首先，也是最重要的一点就是压测隔离。利用线上场景进行压测，不能污染线上真实用户的信息。这需要线上的集群能识别出压测的流量，只要能识别出压测请求的流量，那么流量触发的读写操作就很好统一去做隔离了。通常的解决方案为采用影子库的手段。影子表为和线上结构一致，但是处于隔离位置的可写压测数据表。同时为了区分压测流量与实际流量，一般会在Http header中添加特殊标识符加以分别（这里需要注意压测标识需要在全链路中透传，涉及到跨线程、服务传参的问题）。

其次，线上压测又可能会影响到真实用户的体验，所以要选择业务流量小的时段进行（通常在夜间执行）。同时线上压测有可能触发流量降级策略、异常流量攻击识别策略等问题。这需要在进行压测开始前，有针对性的放松安全策略，或根据特殊标记识别。



----

#### 压测结束后的工作

压测结束后，需要将压测数据、监控数据进行整理复盘。分析当前系统存在的瓶颈、优化计划以及下一次压测计划。同时还要处理影子表的数据，为下一次压测做准备。







参考文献：

- [全链路压测平台（Quake）在美团中的实践](https://tech.meituan.com/2018/09/27/quake-introduction.html)
- [全链路压测自动化实践](https://tech.meituan.com/2019/02/14/full-link-pressure-test-automation.html)
- [字节跳动全链路压测(Rhino)的实践](https://blog.csdn.net/ByteDanceTech/article/details/109040406)
- [有赞全链路压测实战](https://cloud.tencent.com/developer/article/1404093)
